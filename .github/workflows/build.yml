name: Build and Test

on:
  push:
    branches: [ main, develop, github-actions-temp ]
  pull_request:
    branches: [ main, develop ]

env:
  GODOT_VERSION: 4.4.1
  EXPORT_NAME: KOKTKaraokeParty
  DOTNET_VERSION: 8.0.x

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            **/TestResults/**/*.xml
            **/TestResults/**/*.trx

  build:
    runs-on: ${{ matrix.runner }}
    name: Build ${{ matrix.name }}
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - identifier: windows-desktop
            name: Windows Desktop
            runner: windows-latest
            export-preset: "Windows Desktop"
          # TODO: Enable these builds once deployment targets are tested
          # - identifier: linux-x11
          #   name: Linux/X11
          #   runner: ubuntu-latest
          #   export-preset: "Linux/X11"
          # - identifier: macos
          #   name: macOS
          #   runner: macos-latest
          #   export-preset: "macOS"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Setup Godot
        uses: chickensoft-games/setup-godot@v2
        with:
          version: ${{ env.GODOT_VERSION }}
          include-templates: true

      - name: Verify Godot installation
        run: |
          Write-Host "Checking Godot installation..."
          Write-Host "Godot symlink location: $(Get-Command godot -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)"
          Write-Host "Testing symlink..."
          godot --version 2>&1
          Write-Host "Testing direct executable..."
          $godotPath = Get-ChildItem "C:\Users\runneradmin\godot" -Recurse -Filter "Godot_*.exe" | Where-Object { $_.Name -notlike "*console*" } | Select-Object -First 1 -ExpandProperty FullName
          Write-Host "Direct Godot path: $godotPath"
          & "$godotPath" --version
          Write-Host "Working directory: $(Get-Location)"

      - name: Import project (generates .godot folder)
        run: |
          Write-Host "Starting Godot project import..."
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Project files:"
          Get-ChildItem -Name
          
          $godotPath = Get-ChildItem "C:\Users\runneradmin\godot" -Recurse -Filter "Godot_*.exe" | Where-Object { $_.Name -notlike "*console*" } | Select-Object -First 1 -ExpandProperty FullName
          Write-Host "Using Godot at: $godotPath"
          
          Write-Host "Running Godot import..."
          & "$godotPath" --headless --verbose --import --quit
          Write-Host "Import completed."
          Write-Host "Generated .godot folder contents:"
          if (Test-Path ".godot") { Get-ChildItem ".godot" -Recurse -Name | Select-Object -First 10 }
        working-directory: ./KOKTKaraokeParty

      - name: Create export preset if missing
        run: |
          Write-Host "Checking for export presets..."
          if (-not (Test-Path "export_presets.cfg")) {
            Write-Host "Creating minimal export preset for Windows..."
            $presetContent = @"
          [preset.0]

          name="Windows Desktop"
          platform="Windows Desktop"
          runnable=true
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path=""
          patch_list=PackedStringArray()
          encryption_include_filters=""
          encryption_exclude_filters=""
          encrypt_pck=false
          encrypt_directory=false
          script_export_mode=1
          script_encryption_key=""

          [preset.0.options]

          custom_template/debug=""
          custom_template/release=""
          debug/export_console_wrapper=true
          binary_format/embed_pck=false
          texture_format/bptc=true
          texture_format/s3tc=true
          texture_format/etc=false
          texture_format/etc2=false
          binary_format/architecture="x86_64"
          codesign/enable=false
          application/modify_resources=true
          application/icon=""
          application/console_wrapper_icon=""
          application/icon_interpolation=4
          application/file_version=""
          application/product_version=""
          application/company_name=""
          application/product_name=""
          application/file_description=""
          application/copyright=""
          application/trademarks=""
          application/export_angle=0
          ssh_remote_deploy/enabled=false
          "@
            $presetContent | Out-File -FilePath "export_presets.cfg" -Encoding UTF8
            Write-Host "Export preset created."
          } else {
            Write-Host "Export presets found:"
            Get-Content "export_presets.cfg" | Select-Object -First 20
          }
        working-directory: ./KOKTKaraokeParty

      - name: Restore .NET dependencies
        run: dotnet restore
        working-directory: ./KOKTKaraokeParty

      - name: Build .NET project
        run: dotnet build --configuration Release --no-restore
        working-directory: ./KOKTKaraokeParty

      - name: Export project
        run: |
          Write-Host "Starting project export..."
          
          $godotPath = Get-ChildItem "C:\Users\runneradmin\godot" -Recurse -Filter "Godot_*.exe" | Where-Object { $_.Name -notlike "*console*" } | Select-Object -First 1 -ExpandProperty FullName
          Write-Host "Using Godot at: $godotPath"
          
          Write-Host "Available export presets:"
          & "$godotPath" --headless --list
          
          Write-Host "Creating builds directory..."
          New-Item -ItemType Directory -Force -Path "builds\${{ matrix.identifier }}"
          
          Write-Host "Current directory contents:"
          Get-ChildItem -Name
          
          Write-Host "Attempting export..."
          $exportPath = "builds\${{ matrix.identifier }}\${{ env.EXPORT_NAME }}${{ matrix.identifier == 'windows-desktop' && '.exe' || '' }}"
          Write-Host "Export path: $exportPath"
          
          & "$godotPath" --headless --verbose --export-debug "${{ matrix.export-preset }}" "$exportPath"
          
          Write-Host "Export completed."
          Write-Host "Build directory contents:"
          if (Test-Path "builds\${{ matrix.identifier }}") {
            Get-ChildItem "builds\${{ matrix.identifier }}" -Recurse
          } else {
            Write-Host "Build directory not found!"
          }
        working-directory: ./KOKTKaraokeParty

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.identifier }}-build
          path: KOKTKaraokeParty/builds/${{ matrix.identifier }}
          retention-days: 7
          if-no-files-found: error